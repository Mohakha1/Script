-- الخدمات
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players           = game:GetService("Players")
local RunService        = game:GetService("RunService")
local localPlayer       = Players.LocalPlayer

-- قائمة الألوان (للتأثيرات المختلفة والخلفيات الديناميكية)
local colors = {
    Color3.fromRGB(255,   0,   0),   -- أحمر
    Color3.fromRGB(0,   255,   0),     -- أخضر
    Color3.fromRGB(0,     0, 255),      -- أزرق
    Color3.fromRGB(255, 255,   0),       -- أصفر
    Color3.fromRGB(255, 165,   0),       -- برتقالي
    Color3.fromRGB(75,    0, 130),       -- بنفسجي غامق
    Color3.fromRGB(255,  20, 147),        -- وردي فاقع
    Color3.fromRGB(0,   255, 255),        -- سماوي
    Color3.fromRGB(255, 105, 180),         -- وردي ناعم
    Color3.fromRGB(138,  43, 226),         -- بنفسجي ملكي
    Color3.fromRGB(0,   191, 255),         -- أزرق سماوي فاقع
    Color3.fromRGB(0,   250, 154),         -- أخضر نعناعي
    Color3.fromRGB(255,  99,  71),         -- طماطمي
    Color3.fromRGB(123, 104, 238),         -- بنفسجي باهت
    Color3.fromRGB(173, 255,  47),         -- أخضر فسفوري
    Color3.fromRGB(255,   0, 255),         -- أرجواني
    Color3.fromRGB(192, 192, 192),         -- رمادي فاتح
    Color3.fromRGB(0,   128, 128),         -- تركواز غامق
}

-- دالة دمج لونين (للتدرّج والتأثيرات الخلفية)
local function blendColors(c1, c2, alpha)
    return Color3.new(
        c1.R * (1 - alpha) + c2.R * alpha,
        c1.G * (1 - alpha) + c2.G * alpha,
        c1.B * (1 - alpha) + c2.B * alpha
    )
end

-----------------------------------------------------------
-- تأثيرات "الاسم"
-----------------------------------------------------------
local gradientRunning = false
local function startGradient()
    if gradientRunning then return end
    gradientRunning = true
    task.spawn(function()
        local idx = 1
        while gradientRunning do
            local c1 = colors[idx]
            local c2 = colors[idx + 1] or colors[1]
            for i = 0, 1, 0.05 do
                if not gradientRunning then return end
                local blended = blendColors(c1, c2, i)
                ReplicatedStorage.RE:FindFirstChild("1RPNam1eColo1r"):FireServer("PickingRPNameColor", blended)
                wait(0.25)
            end
            idx = idx + 1
            if idx > #colors then idx = 1 end
            wait(1)
        end
    end)
end
local function stopGradient()
    gradientRunning = false
end

local blinkRunning = false
local function startBlink()
    if blinkRunning then return end
    blinkRunning = true
    task.spawn(function()
        local idx = 1
        while blinkRunning do
            ReplicatedStorage.RE:FindFirstChild("1RPNam1eColo1r"):FireServer("PickingRPNameColor", colors[idx])
            idx = idx + 1
            if idx > #colors then idx = 1 end
            wait(1.2)
        end
    end)
end
local function stopBlink()
    blinkRunning = false
end

local waveRunning = false
local function startWave()
    if waveRunning then return end
    waveRunning = true
    task.spawn(function()
        while waveRunning do
            for _, color in ipairs(colors) do
                if not waveRunning then return end
                ReplicatedStorage.RE:FindFirstChild("1RPNam1eColo1r"):FireServer("PickingRPNameColor", color)
                wait(0.3)
            end
        end
    end)
end
local function stopWave()
    waveRunning = false
end

OrionLib:MakeNotification({
    Name    = "تنبيه",
    Content = "تدرّج، وميض، وموجة ألوان الاسم جاهزون في تبويب الألوان > الاسم",
    Time    = 5,
})

-----------------------------------------------------------
-- تأثيرات "البايو"
-----------------------------------------------------------
local gradientBioRunning = false
local function startGradientBio()
    if gradientBioRunning then return end
    gradientBioRunning = true
    task.spawn(function()
        local idx = 1
        while gradientBioRunning do
            local c1 = colors[idx]
            local c2 = colors[idx + 1] or colors[1]
            for i = 0, 1, 0.05 do
                if not gradientBioRunning then return end
                local blended = blendColors(c1, c2, i)
                ReplicatedStorage.RE:FindFirstChild("1RPNam1eColo1r"):FireServer("PickingRPBioColor", blended)
                wait(0.25)
            end
            idx = idx + 1
            if idx > #colors then idx = 1 end
            wait(1)
        end
    end)
end
local function stopGradientBio()
    gradientBioRunning = false
end

local blinkBioRunning = false
local function startBlinkBio()
    if blinkBioRunning then return end
    blinkBioRunning = true
    task.spawn(function()
        local idx = 1
        while blinkBioRunning do
            ReplicatedStorage.RE:FindFirstChild("1RPNam1eColo1r"):FireServer("PickingRPBioColor", colors[idx])
            idx = idx + 1
            if idx > #colors then idx = 1 end
            wait(1.2)
        end
    end)
end
local function stopBlinkBio()
    blinkBioRunning = false
end

local waveBioRunning = false
local function startWaveBio()
    if waveBioRunning then return end
    waveBioRunning = true
    task.spawn(function()
        while waveBioRunning do
            for _, color in ipairs(colors) do
                if not waveBioRunning then return end
                ReplicatedStorage.RE:FindFirstChild("1RPNam1eColo1r"):FireServer("PickingRPBioColor", color)
                wait(0.3)
            end
        end
    end)
end
local function stopWaveBio()
    waveBioRunning = false
end

-----------------------------------------------------------
-- تهيئة المكتبة والواجهة وإنشاء التبويبات
-----------------------------------------------------------
OrionLib:Init()
local Window = OrionLib:MakeWindow({
    Name         = "منيو محمد TN | الفخم",
    HidePremium  = false,
    SaveConfig   = true,
    ConfigFolder = "TNMenuConfig",
})

-----------------------------------------------------------
-- ميزة الخلفية الديناميكية
-----------------------------------------------------------
local dynamicBackgroundRunning = false
local function startDynamicBackground()
    if dynamicBackgroundRunning then return end
    dynamicBackgroundRunning = true
    task.spawn(function()
        local idx = 1
        while dynamicBackgroundRunning do
            local c1 = colors[idx]
            local c2 = colors[idx + 1] or colors[1]
            for i = 0, 1, 0.05 do
                if not dynamicBackgroundRunning then break end
                local blended = blendColors(c1, c2, i)
                -- محاولة تغيير خلفية النافذة إذا كانت الدالة متوفرة في OrionLib
                pcall(function()
                    if Window.SetBackgroundColor then
                        Window:SetBackgroundColor(blended)
                    end
                end)
                wait(0.1)
            end
            idx = idx + 1
            if idx > #colors then idx = 1 end
        end
    end)
end
local function stopDynamicBackground()
    dynamicBackgroundRunning = false
end

-----------------------------------------------------------
-- إعدادات اللاعب والخصائص الافتراضية
-----------------------------------------------------------
local jumpPower   = 150
local walkSpeed   = 50
local enableJump  = false
local enableSpeed = false

local function updateJumpPower()
    local h = localPlayer.Character and localPlayer.Character:FindFirstChild("Humanoid")
    if h then h.JumpPower = enableJump and jumpPower or 50 end
end
local function updateWalkSpeed()
    local h = localPlayer.Character and localPlayer.Character:FindFirstChild("Humanoid")
    if h then h.WalkSpeed = enableSpeed and walkSpeed or 16 end
end

local function resetSettings()
    jumpPower   = 150
    walkSpeed   = 50
    enableJump  = false
    enableSpeed = false
    updateJumpPower()
    updateWalkSpeed()

    stopGradient()
    stopBlink()
    stopWave()
    stopGradientBio()
    stopBlinkBio()
    stopWaveBio()
    stopDynamicBackground()

    if followConn then followConn:Disconnect() end
    if sitHeadConn then sitHeadConn:Disconnect() end

    OrionLib:MakeNotification({Name="إعادة تعيين", Content="تم استعادة الإعدادات الافتراضية", Time = 5})
end

-----------------------------------------------------------
-- إنشاء التبويبات
-----------------------------------------------------------
local tabMain    = Window:MakeTab({ Name = "الصفحة الرئيسية", Icon = "🏠" })
local tabPlayer  = Window:MakeTab({ Name = "اللاعب",         Icon = "🕹️" })
local tabControl = Window:MakeTab({ Name = "أغراض تحكم",    Icon = "⚙️" })
local tabScripts = Window:MakeTab({ Name = "سكربتات",        Icon = "🧩" })
local tabTarget  = Window:MakeTab({ Name = "استهداف",        Icon = "🎯" })
local tabItems   = Window:MakeTab({ Name = "أغراض",          Icon = "🎒" })
local tabColors  = Window:MakeTab({ Name = "ألوان",          Icon = "🎨" })
local tabSettings = Window:MakeTab({ Name = "الإعدادات",      Icon = "🛠️" })

-----------------------------------------------------------
-- تبويب اللاعب
-----------------------------------------------------------
local noclipConn
tabPlayer:AddTextbox({
    Name             = "قوة القفز",
    Default          = tostring(jumpPower),
    ClearTextOnFocus = false,
    Callback         = function(v)
        jumpPower = tonumber(v) or 150
        updateJumpPower()
    end,
})
tabPlayer:AddTextbox({
    Name             = "سرعة المشي",
    Default          = tostring(walkSpeed),
    ClearTextOnFocus = false,
    Callback         = function(v)
        walkSpeed = tonumber(v) or 50
        updateWalkSpeed()
    end,
})
tabPlayer:AddToggle({
    Name     = "تفعيل القفز",
    Default  = false,
    Callback = function(s)
        enableJump = s
        updateJumpPower()
    end,
})
tabPlayer:AddToggle({
    Name     = "تفعيل السرعة",
    Default  = false,
    Callback = function(s)
        enableSpeed = s
        updateWalkSpeed()
    end,
})
tabPlayer:AddButton({
    Name     = "تنقل",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Mohakha1/-/refs/heads/main/Teleport.txt"))()
    end,
})
tabPlayer:AddToggle({
    Name     = "Noclip",
    Default  = false,
    Callback = function(s)
        if s then
            noclipConn = RunService.Stepped:Connect(function()
                for _, part in ipairs(localPlayer.Character:GetDescendants()) do
                    if part:IsA("BasePart") then part.CanCollide = false end
                end
            end)
        else
            if noclipConn then noclipConn:Disconnect() end
        end
    end,
})

-----------------------------------------------------------
-- تبويب التحكم
-----------------------------------------------------------
local wallClimbConn
tabControl:AddToggle({
    Name     = "إزالة لاق",
    Default  = false,
    Callback = function(s)
        if s then
            for _, v in ipairs(workspace:GetDescendants()) do
                if v:IsA("ParticleEmitter")
                or v:IsA("Trail")
                or v:IsA("Smoke")
                or v:IsA("Fire")
                or v:IsA("Sparkles") then
                    v:Destroy()
                end
            end
        end
    end,
})
tabControl:AddToggle({
    Name     = "تسلق جدران",
    Default  = false,
    Callback = function(s)
        if s then
            wallClimbConn = RunService.Heartbeat:Connect(function()
                local hrp = localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local ray = Ray.new(hrp.Position, hrp.CFrame.LookVector * 3)
                    if workspace:FindPartOnRay(ray, localPlayer.Character) then
                        hrp.Velocity = Vector3.new(0,50,0)
                    end
                end
            end)
        else
            if wallClimbConn then wallClimbConn:Disconnect() end
        end
    end,
})
tabControl:AddButton({
    Name     = "اختفاء",
    Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/GGH52lan/GGH52lan/main/Invis.lua"))() end,
})
tabControl:AddButton({
    Name     = "طيران",
    Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/Mohakha1/-/refs/heads/main/Protected_7047204136562154%20(1).txt"))() end,
})
tabControl:AddButton({
    Name     = "كشف الاقفال",
    Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/Mohakha1/-/refs/heads/main/Tor.txt"))() end,
})

-----------------------------------------------------------
-- تبويب السكربتات
-----------------------------------------------------------
tabScripts:AddButton({ Name = "ساندر اكس", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/sXPiterXs1111/SanderXV2.65/main/sanderXNewV2.65.lua"))() end })
tabScripts:AddButton({ Name = "ايس هيب", Callback = function() loadstring(game:HttpGet("https://orbitsc.net/brook"))() end })
tabScripts:AddButton({ Name = "Project Script", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/ProjectSunterium/Project-Sunterium/refs/heads/main/Project%20Sunterium"))() end })
tabScripts:AddButton({ Name = "Orbitsc", Callback = function() loadstring(game:HttpGet("https://orbitsc.net/brook"))() end })
tabScripts:AddButton({ Name = "Darkon", Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/TheDarkoneMarcillisePex/Other-Scripts/main/Brook%20Haven%20Gui"))() end })

-----------------------------------------------------------
-- تبويب الاستهداف
-----------------------------------------------------------
local dropdownInst, followConn, sitHeadConn, selectedName
local function startFollow(name)
    if followConn then followConn:Disconnect() end
    followConn = RunService.Heartbeat:Connect(function()
        local hrp = localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")
        local t   = Players:FindFirstChild(name)
        if hrp and t and t.Character then
            local th = t.Character:FindFirstChild("HumanoidRootPart")
            if th then hrp.CFrame = th.CFrame + Vector3.new(0,3,0) end
        end
    end)
end
local function bang1(name)
    local target = Players:FindFirstChild(name)
    if not target then 
        OrionLib:MakeNotification({Name="خطأ", Content="لاعب غير موجود", Time=5})
        return 
    end
    local targetChar = target.Character or target.CharacterAdded:Wait()
    local targetHead = targetChar:WaitForChild("Head")
    local myChar     = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    local hrp        = myChar:WaitForChild("HumanoidRootPart")
    local humanoid   = myChar:WaitForChild("Humanoid")
    humanoid.Sit     = true
    hrp.CFrame       = CFrame.new(targetHead.Position + Vector3.new(0, 2.1, -0.5))
    for _, v in ipairs(hrp:GetChildren()) do
        if v:IsA("Attachment") or v:IsA("AlignPosition") or v:IsA("AlignOrientation") then
            v:Destroy()
        end
    end
    local myAttach   = Instance.new("Attachment", hrp)
    local headAttach = Instance.new("Attachment", targetHead)
    local alignPos   = Instance.new("AlignPosition", hrp)
    alignPos.Attachment0    = myAttach
    alignPos.Attachment1    = headAttach
    alignPos.RigidityEnabled = true
    alignPos.Responsiveness  = 200
    alignPos.MaxForce        = math.huge
    local alignOri   = Instance.new("AlignOrientation", hrp)
    alignOri.Attachment0    = myAttach
    alignOri.Attachment1    = headAttach
    alignOri.RigidityEnabled = true
    alignOri.Responsiveness  = 200
    alignOri.MaxTorque       = math.huge
    local t = 0
    if sitHeadConn then sitHeadConn:Disconnect() end
    sitHeadConn = RunService.RenderStepped:Connect(function(dt)
        t = t + dt
        local sway = math.sin(t * 20) * 0.3
        myAttach.Position = Vector3.new(0, 2.1, -0.5 + sway)
    end)
    OrionLib:MakeNotification({Name="تم التفعيل", Content="bang1 مفعل على: " .. name, Time=5})
end

dropdownInst = tabTarget:AddDropdown({
    Name    = "اختر لاعب",
    Default = "",
    Options = {},
    Callback= function(v) selectedName = v end,
})
tabTarget:AddToggle({
    Name    = "تتبع",
    Default = false,
    Callback= function(state)
        if state then
            if not selectedName then 
                OrionLib:MakeNotification({Name="خطأ", Content="اختر لاعب أولاً!", Time=5})
                return 
            end
            startFollow(selectedName)
            OrionLib:MakeNotification({Name="تم التفعيل", Content="تتبع مفعل", Time=5})
        else
            if followConn then followConn:Disconnect() end
            OrionLib:MakeNotification({Name="تم الإيقاف", Content="تتبع مُعطّل", Time=5})
        end
    end,
})
tabTarget:AddToggle({
    Name    = "bang1",
    Default = false,
    Callback= function(state)
        if state then
            if not selectedName then 
                OrionLib:MakeNotification({Name="خطأ", Content="اختر لاعب أولاً!", Time=5})
                return 
            end
            bang1(selectedName)
        else
            if sitHeadConn then sitHeadConn:Disconnect() end
            local char = localPlayer.Character
            if char then
                local humanoid = char:FindFirstChild("Humanoid")
                local hrp      = char:FindFirstChild("HumanoidRootPart")
                if humanoid then humanoid.Sit = false end
                if hrp then
                    for _, v in ipairs(hrp:GetChildren()) do
                        if v:IsA("Attachment") or v:IsA("AlignPosition") or v:IsA("AlignOrientation") then
                            v:Destroy()
                        end
                    end
                end
            end
            OrionLib:MakeNotification({Name="تم الإيقاف", Content="bang1 مُعطّل", Time=5})
        end
    end,
})
local function busKill()
    if not selectedName then
        OrionLib:MakeNotification({Name="خطأ", Content="اختر لاعب أولاً!", Time=5})
        return
    end
    local player = game.Players.LocalPlayer
    local target = game.Players:FindFirstChild(selectedName)
    if not target then 
        OrionLib:MakeNotification({Name="خطأ", Content="لاعب غير موجود", Time=5})
        return 
    end
    local localChar = player.Character or player.CharacterAdded:Wait()
    local hrp = localChar:FindFirstChild("HumanoidRootPart")
    if not hrp then 
        OrionLib:MakeNotification({Name="خطأ", Content="لا يوجد HumanoidRootPart", Time=5})
        return 
    end

    local originalCFrame = hrp.CFrame
    local firstCFrame = CFrame.new(1039.02393, 78.6514969, -1034.72437,
        -0.549868405, 0.0108198766, -0.835181236,
        -8.43425005e-05, 0.999915361, 0.0130095575,
        0.835251272, 0.00722398562, -0.54982096)
    local secondCFrame = CFrame.new(1051.32434, 78.612854, -1038.99731,
        0.82696569, 0.00431149732, -0.562235892,
        0.00424380461, 0.999894261, 0.0139096817,
        0.562236369, -0.0138888489, 0.826859951)
    
    hrp.CFrame = firstCFrame
    task.wait(0.5)
    
    local remote = game:GetService("ReplicatedStorage"):FindFirstChild("RE"):FindFirstChild("1Ca1r")
    if remote then
        remote:FireServer("PickingCar", "SchoolBus")
    end
    
    task.wait(1.5)
    hrp.CFrame = secondCFrame
    task.wait(0.2)
    
    local targetHRP = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
    if targetHRP then
        local startTime = tick()
        while tick() - startTime < 3 do
            local angle = (tick() - startTime) * 20
            local radius = 5
            local offset = Vector3.new(math.cos(angle) * radius, 0, math.sin(angle) * radius)
            hrp.CFrame = CFrame.new(targetHRP.Position + offset) * CFrame.Angles(0, math.rad(angle * 60), 0)
            task.wait()
        end
    end
    
    hrp.CFrame = CFrame.new(hrp.Position.X, -100, hrp.Position.Z)
    task.wait(0.05)
    
    local deleteArgs = { [1] = "DeleteAllVehicles" }
    local deleteRemote = game:GetService("ReplicatedStorage").RE:F
